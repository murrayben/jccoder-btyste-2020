{% extends "base.html" %}

{% block navbar %}

{% endblock %}

{% block styles %}
    {{ super() }}
    <style>
        html {
            overflow: hidden;
        }
        body {
            padding-top: 0 !important;
            padding-bottom: 10px;
            background-color: #ffffff;
        }

        div.question {
            margin-bottom: 10px;
        }

        h3 {
            margin-top: 5px;
        }

        .fa-check {
            color: #008000;
        }

        .fa-times {
            color: #ff0000;
        }

        .history-badge {
            border-radius: 50px;
            vertical-align: middle;
            padding: 8px 9px 7px;
            margin-right: 3px;
            display: inline-block;
            font-size: 1.2em;
            margin-bottom: 5px;
        }

        .badge-correct {
            background-color: #5ad65a;
            border: none;
        }

        .badge-incorrect {
            background-color: #d43e3e;
            border: none;
        }

        .no-ans {
            border: 2px solid #a7a7a7;
            padding: 17.5px;
        }

        .history-badge .fas, .history-badge .far {
            color: #ffffff !important;
        }

        #history {
            width: 100%;
            text-align: right;
            /* margin-bottom: 25px; */
            display: inline-block;
            padding: 10px;
        }

        .answer-status {
            float: left;
            font-size: 24px;
            vertical-align: middle;
        }

        #summary {
            display: none;
        }

        .page-header {
            margin: 0 0 10px;
        }

        #start {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .dot {
            position: relative;
            display: inline-block;
            border-radius: 60px;
            border: 1px solid #646464;
            padding: 0.4rem 0.5rem 0.3rem;
            z-index: 1000;
        }

        .draggable-btn {
            min-width: 100px;
            min-height: 46px;
            border: 1px solid #000000;
            border-radius: 5px;
        }

        .draggable-btn:hover {
            cursor: grab;
        }

        .draggable-btn:active {
            cursor: grabbing;
        }

        .blank {
            vertical-align: middle !important;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container-fluid">
        <div id="start" class="text-center">
            <h3 id="no-problems">Do {{ questions|length }} problem{% if questions|length != 1 %}s{% endif %}!</h3>
            <p id="description">{{ quiz.description }}</p>
            <button type="button" id="start-btn" class="btn btn-primary">Start Quiz</button>
        </div>

        <div class="page-header">
            <h4 id="attempt-status" class="text-center">Attempt #<span id="attempt-no"></span> out of <span id="max-attempts"></span></h4>
        </div>
            
        <div class="progress active">
            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <div id="history">
            <h3 class="answer-status"></h3>
            {% for question in questions %}
            <div class="no-ans history-badge"></div>
            {% endfor %}
        </div>
        <div class="questions">
            {% for question in questions %}
            <div class="question" id="{{ question.id }}" data-max-attempts="{{ question.max_attempts }}" data-at-hint="0">
                {% if question.question_type.code == 'D' %}
                <div class="draggable-items-box card bg-primary mb-3 p-3 flex-row align-items-stretch" style="min-height: 80px;">
                    {% for item in question.options[:-1] %}
                    <span class="draggable-btn bg-white mr-3 d-flex" data-position="{{ loop.index }}">
                        <span class="m-auto text-dark">{{ item.text | safe }}</span>
                    </span>
                    {% endfor %}
                </div>
                {% endif %}
                <div class="mb-3">{{ question.show() | safe }}</div>
                {% if question.question_type.code == 'C' %}
                {% for option in question.options %}
                <div class="form-check">
                    <input type="radio" name="options-{{ question.id }}" />
                    <span class="radio-value">
                        {{ option.text }}
                    </span>
                </div>
                {% endfor %}
                
                {% elif question.question_type.code == 'S' %}
                <input type="text" id="answer" value="" />
                {% endif %}
                <div class="hints-box" style="display: none;"><hr /></div>
                <hr />
                <div class="question-help" style="display: none;">
                    <div class="row">
                        <div class="col-sm-6">
                            <h4>Related Videos</h4>
                            <div class="help-videos">
                                {% with videos = Page.query.filter_by(lesson_id=question.quiz.lesson_id, page_type_id=PageType.query.filter_by(description="Video").first().id).all() %}
                                <ul class="list-unstyled">
                                    {% for video in videos %}
                                    <li class="mb-2">
                                        <a href="{{ url_for('main.lesson_page', id=video.id) }}" target="_blank">
                                            <span class="dot">
                                                <i class="fas fa-play fa-fw"></i>
                                            </span> {{ video.title }}
                                        </a>
                                    </li>
                                {% endfor %}
                                </ul>
                                {% endwith %}
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <h4>Still stuck?</h4>
                            <button role="button" class="btn btn-block btn-outline-success mb-2 get-hint-btn">Get a hint</button>
                            <p>If you use a hint you will be marked wrong! Try to work out the problem first.</p>
                        </div>
                    </div>
                    <hr />
                </div>
                <div class="solution" style="display: none;"></div>
            </div>
            {% endfor %}
        </div>
        <button role="button" class="btn btn-primary" id="next-btn">Check</button>
        <button role="button" class="btn btn-success" id="help-btn">Need help?</button>
        <div id="summary">
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Question</th>
                            <th>Number of attempts</th>
                            <th>Your last attempt</th>
                            <th>Correct Answer</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for question in questions %}
                        <tr id="question-{{ question.id }}">
                            <td class="question-text"></td>
                            <td class="no-attempts"></td>
                            <td class="last-attempt"></td>
                            <td class="correct-ans"></td>
                            <td class="ans-status"></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <!-- Include jQuery UI for drag and drop questions -->
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script type="text/javascript">
        // $radioBtns = $('input[type="radio"]');
        // checkForRadio();
        // $radioBtns.on('change', checkForRadio);

        $(function() {

            $('input[type="radio"]').attr('checked', false);
            $('input[type="text"]').val("");
            $('.question img').addClass('img-fluid');
            var $currentQuestion = $('.question').first();
            
            var tick = $('<span class="fas fa-check fa-fw">');
            var x = $('<span class="fas fa-times fa-fw">');
            var hint_icon = $('<i class="far fa-lightbulb fa-fw">');
            var used_hint = false;

            $('.container-fluid').children().hide();
            $('#start').show();
            $('#start-btn').on('click', function() {
                $('.container-fluid').children().fadeIn();
                $('#start, #summary, .question').hide();
                $currentQuestion.fadeIn(function() {
                    parent.$(parent.document).trigger('quiz_height_update');
                });
                $("#max-attempts").text($currentQuestion.data('max-attempts'));
                updateAttemptNo(true);
                $('#next-btn').on('click', checkQuestion);
            });

            $('#help-btn').on('click', function() {
                $(this).hide();
                $currentQuestion.children(".question-help").first().show(function() {
                    parent.$(parent.document).trigger('quiz_height_update');
                });
            });

            $('.get-hint-btn').on('click', function() {
                var $hints_box = $currentQuestion.children('.hints-box').first();
                $hints_box.show(function() {
                    data = {"hint_no": Number($currentQuestion.attr('data-at-hint')) + 1, "question_id": $currentQuestion.attr('id')}
                    $.ajax({
                        url: "{{ url_for('main.get_hint') }}",
                        data: JSON.stringify(data),
                        dataType: 'json',
                        contentType: "application/json; charset=utf-8",
                        type: 'POST',
                        success: function(response) {
                            $hints_box.append(response.hint_html);
                            $currentQuestion.attr('data-at-hint', Number($currentQuestion.attr('data-at-hint')) + 1)
                            if ($currentQuestion.attr('data-at-hint') === "1") {
                                data = {"hint_used_mark_incorrect": true};
                                $.ajax({
                                    url: "{{ url_for('main.check') }}",
                                    data: JSON.stringify(data),
                                    dataType: 'json',
                                    contentType: "application/json; charset=utf-8",
                                    type: 'POST',
                                    success: function(response) {
                                        var $historyIcon = $('.no-ans').first();
                                        $historyIcon.addClass('badge-incorrect');
                                        $historyIcon.removeClass('no-ans');
                                        $historyIcon.append(hint_icon.clone());
                                        used_hint = true;
                                    }
                                });
                            }
                            if (response.is_last_hint) {
                                $('.get-hint-btn:visible').parent().hide();
                            }
                        },
                        error: function(error) {
                            $hints_box.append("<p>An error has occurred while retriving the hint.</p>");
                        },
                        complete: function(response) {
                            parent.$(parent.document).trigger('quiz_height_update');
                        }
                    });
                });
            });

            // Drag and drop
            $('.draggable-btn').draggable({
                revert: true,
                snapTolerance: 30,
                revertDuration: 100,
                cursor: "move"
            });

            $('.blank').each(function(index) {
                $(this).droppable({
                    accept: '.draggable-btn',
                    drop: function(event, ui) {
                        if ($(this).children('.draggable-btn').length === 0) {
                            $(this).append(ui.draggable);
                            parent.$(parent.document).trigger('quiz_height_update');
                        }
                    }
                });
            });

            function updateAttemptNo(reset=false) {
                if (reset) {
                    attemptNo = 1;
                } else {
                    attemptNo++;
                }
                $("#attempt-no").text(attemptNo);
            }

            function nextQuestion() {
                // Move on to next question
                $currentQuestion.hide();
                $currentQuestion = $currentQuestion.next();
                $currentQuestion.fadeIn();
                used_hint = false;
                $('.solution').hide();
                $('#help-btn').show();
                updateAttemptNo(true);
                $("#max-attempts").text($currentQuestion.data('max-attempts'));
                parent.$(parent.document).trigger('quiz_height_update');
                $('.answer-status').fadeOut(1000, function() {
                    parent.$(parent.document).trigger('quiz_height_update');
                });
            }

            function checkQuestion() {
                $('#next-btn').attr('disabled', 'disabled');
                var $checkedRadioBtns = $currentQuestion.children('.form-check').children('input').filter(':checked');
                var draggedItems = $currentQuestion.children('.draggable-items-box');
                if (draggedItems.length !== 0) {
                    draggedItems = draggedItems.children('.draggable-btn').length;
                } else {
                    draggedItems = undefined;
                }
                var singleAnswer = $currentQuestion.children('#answer');
                singleAnswer =  singleAnswer.length !== 0 ? singleAnswer.val().trim() : false
                if ($checkedRadioBtns.length === 1 || draggedItems === 0 || singleAnswer) {
                    // Check question
                    if ($checkedRadioBtns.length === 1) {
                        var data = {"answer": $checkedRadioBtns.next().text(), "question_id": $currentQuestion.attr('id')};
                    } else if (draggedItems === 0) {
                        var answerDragDrop = "";
                        for (var i = 0; i < $('.draggable-btn:visible').length; i++) {
                            answerDragDrop += (i + 1) + "=" + $('.blank:visible').eq(i).children('.draggable-btn').data('position') + " ";
                        }
                        answerDragDrop = answerDragDrop.trim();
                        var data = {"answer": answerDragDrop, "question_id": $currentQuestion.attr('id')}
                    } else {
                        var data = {"answer": singleAnswer, "question_id": $currentQuestion.attr('id')};
                    }

                    data.used_hint = used_hint;
                    $.ajax({
                        url: "{{ url_for('main.check') }}",
                        data: JSON.stringify(data),
                        dataType: 'json',
                        contentType: "application/json; charset=utf-8",
                        type: 'POST',
                        success: function(response) {
                            $('#next-btn').removeAttr('disabled');
                            parent.$(parent.document).trigger('quiz_height_update');
                            var isLastQuestion = $('.question').eq(-1).is($currentQuestion);
                            var try_again = response.try_again
                            if (!try_again) {
                                $progressBar = $('.progress-bar');
                                $progressWidth = parseInt($progressBar.css('width'), 10) / parseInt($progressBar.parent().width(), 10) * 100;
                                newWidth = $progressWidth + Math.pow($('.question').length, -1) * 100
                                newWidth = newWidth.toFixed(0)
                                if (isLastQuestion) {
                                    newWidth = 100
                                }
                                $progressBar.css('width', newWidth + '%');
                                $progressBar.attr('aria-valuenow', newWidth);
                                $progressBar.text(newWidth + '%');
                            }
                            if (response.answer_status) {
                                $('.answer-status').html("<span style=\"color:#5ad65a\">Correct!</span>").hide().fadeIn(1000);
                                if (!used_hint) {
                                    var $historyIcon = $('.no-ans').first();
                                    $historyIcon.addClass('badge-correct');
                                    $historyIcon.removeClass('no-ans');
                                    $historyIcon.append(tick.clone());
                                }
                                updateAttemptNo(true);
                            } else if (try_again) {
                                updateAttemptNo();
                                if (attemptNo === $currentQuestion.data('max-attempts')) {
                                    $('.answer-status').html("<span style=\"color:#d43e3e\">Last chance! Try Again.</span>").hide().fadeIn(1000).delay(1000).fadeOut(1000);
                                } else {
                                    $('.answer-status').html("<span style=\"color:#d43e3e\">Incorrect! Try Again.</span>").hide().fadeIn(1000).delay(1000).fadeOut(1000);
                                }
                            } else {
                                $('.answer-status').html("<span style=\"color:#d43e3e\">Hard Luck!</span>").hide().fadeIn(1000);
                                if (!used_hint) {
                                    var $historyIcon = $('.no-ans').first();
                                    $historyIcon.addClass('badge-incorrect');
                                    $historyIcon.removeClass('no-ans');
                                    $historyIcon.append(x.clone());
                                    var $solutionDiv = $currentQuestion.children('.solution');
                                    $solutionDiv.append('<h4>Explanation</h4>')
                                    $solutionDiv.append(response.solution_html + '<hr />');
                                    $solutionDiv.show(function() {
                                        $('#help-btn').hide()
                                        parent.$(parent.document).trigger('quiz_height_update');
                                    });
                                } else {
                                    $('#help-btn').hide()
                                    parent.$(parent.document).trigger('quiz_height_update');
                                }
                            }
                            if (!try_again) {
                                isLastQuestion ? $('#next-btn').html('Summary of quiz &#8594;') : $('#next-btn').html('Continue &#8594;');
                                parent.$(parent.document).trigger('quiz_height_update');
                                $('#next-btn').off('click').on('click', function() {
                                    if (isLastQuestion) {
                                        // Summary of user's answers
                                        $('#next-btn').fadeOut();
                                        $('#help-btn').fadeOut();
                                        $currentQuestion.fadeOut();
                                        $('.page-header').fadeOut();
                                        $('.answer-status').fadeOut();
                                        var data = {'id': '{{ quiz.id }}'};
                                        $.ajax({
                                            url: "{{ url_for('main.summary') }}",
                                            data: JSON.stringify(data),
                                            contentType: 'application/json',
                                            type: 'POST',
                                            success: function(response) {
                                                var $summary = $('#summary');
                                                for (var i = 0; i < $('tbody tr').length; i++) {
                                                    var thisQuesID = response.question_ids[i]
                                                    var $row = $('tr#question-' + thisQuesID)
                                                    var $rowChildren = $row.children();
                                                    $rowChildren.filter('.question-text').html(response.questions[i]);
                                                    $rowChildren.filter('.no-attempts').text(response.no_attempts[i]);
                                                    $rowChildren.filter('.last-attempt').text(response.last_attempts[i]);
                                                    $rowChildren.filter('.correct-ans').text(response.correct_answers[i]);
                                                    if (response.user_ans_status[i]) {
                                                        $rowChildren.filter('.ans-status').append(tick.clone());
                                                    } else {
                                                        $rowChildren.filter('.ans-status').append(x.clone());
                                                    }
                                                }
                                                $summary.fadeIn(function () {
                                                    parent.$(parent.document).trigger('quiz_height_update');
                                                });
                                            },
                                            error: function(error) {
                                                $('.status').text("There has been an error.")
                                            }
                                        });
                                    } else {
                                        $('#next-btn').text('Check').off('click').on('click', checkQuestion);
                                        nextQuestion();
                                    }
                                });
                                
                            }
                        },
                        error: function(error) {
                            $('.answer-status').html("There has been an error in processing your answer.");
                        }
                    });
                        
                } else {
                    $('#next-btn').removeAttr('disabled');
                }
            }
        });
    </script>
{% endblock %}